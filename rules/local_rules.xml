<?xml version="1.0" encoding="UTF-8"?>
<ruleset>

  <!--
    Goal: Detect N failed SSH logins from same src IP within 60s,
          followed by a successful login from that same IP,
          using a "previously unseen" username (simulated by excluding common accounts).
    MITRE ATT&CK: T1110 (Brute Force)
    Rule IDs: >= 100000 (custom namespace)
  -->

  <!-- Minimal fallback decoder (kept here for portability). If you already rely on built-in sshd decoders, you can remove this. -->
  <decoder name="local-sshd-fallback">
    <prematch>sshd</prematch>
    <regex><![CDATA[.* (?P<action>Failed|Accepted) password for (invalid user )?(?P<user>[A-Za-z0-9._-]+) from (?P<srcip>\d{1,3}(?:\.\d{1,3}){3}) .*]]></regex>
    <order>action,user,srcip</order>
  </decoder>

  <group name="local,ssh,authentication,bruteforce">

    <!-- 100000: Failed SSH login -->
    <rule id="100000" level="5">
      <if_group>ssh|sshd|local-sshd-fallback</if_group>
      <match>Failed password for</match>
      <description>SSH authentication failure</description>
      <group>authentication_failed,ssh,sshd</group>
      <field name="srcip"><![CDATA[\d{1,3}(?:\.\d{1,3}){3}]]></field>
      <mitre><id>T1110</id></mitre>
    </rule>

    <!-- 100001: N (default 4) failures from same srcip within 60s -->
    <rule id="100001" level="8" frequency="4" timeframe="60">
      <if_matched_sid>100000</if_matched_sid>
      <same_source_ip/>
      <description>Multiple SSH authentication failures from same source IP (>=4 in 60s)</description>
      <group>bruteforce,aggregation,ssh,sshd</group>
      <mitre><id>T1110</id></mitre>
    </rule>

    <!-- 100002: Successful SSH login -->
    <rule id="100002" level="5">
      <if_group>ssh|sshd|local-sshd-fallback</if_group>
      <match>Accepted password for</match>
      <description>SSH authentication success</description>
      <group>authentication_success,ssh,sshd</group>
      <field name="srcip"><![CDATA[\d{1,3}(?:\.\d{1,3}){3}]]></field>
      <mitre><id>T1110</id></mitre>
    </rule>

    <!-- 100003: Success after prior failures from same IP AND "new" username (simulated) -->
    <rule id="100003" level="12">
      <!-- correlation: first confirm prior brute-force pattern -->
      <if_matched_sid>100001</if_matched_sid>
      <same_source_ip/>
      <!-- then the success -->
      <if_matched_sid>100002</if_matched_sid>

      <!-- Extract user & srcip from the success line -->
      <regex><![CDATA[Accepted password for (?P<user>.+?) from (?P<srcip>\d{1,3}(?:\.\d{1,3}){3})]]></regex>

      <!-- Simulate "previously unseen user" by excluding a baseline allowlist -->
      <not_regex><![CDATA[Accepted password for (root|ubuntu|ec2-user|admin|debian|centos|backup|ops)\b]]></not_regex>

      <description>Potential brute-force: multiple SSH failures followed by success from same IP with uncommon user</description>
      <group>correlation,ssh,sshd,bruteforce</group>
      <mitre><id>T1110</id></mitre>
      <options>no_full_log</options>
      <info type="text">srcip: $(srcip), user: $(user), window: 60s</info>
    </rule>

  </group>
</ruleset>
